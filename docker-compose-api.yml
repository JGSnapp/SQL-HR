services:
  agent_server:
    build:
      context: ./agent_server
    depends_on:
      postgres:
        condition: service_healthy
    env_file:
      - .env
    environment:
      USE_VLLM: ${USE_VLLM:-true}
      LLM_BASE_URL: ${LLM_BASE_URL:-http://vllm:8001/v1}
      VLLM_MODEL: ${VLLM_MODEL:-Qwen/Qwen2.5-7B-Instruct-GPTQ-Int4}
      VLLM_KEY: ${VLLM_KEY:-fake-key}
      VLLM_BASE_URL: ${VLLM_BASE_URL:-http://vllm:8001/v1}
      PROXY_MODEL: ${PROXY_MODEL:-gpt-4o-mini}
      PROXY_API_KEY: ${PROXY_API_KEY:-}
      PROXY_BASE_URL: ${PROXY_BASE_URL:-https://api.openai.com/v1}
      RESULT_FILE: /results/result.txt
    volumes:
      - ./results:/results
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://127.0.0.1:8000/health')\""]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 20s

  frontend:
    build:
      context: ./frontend
    depends_on:
      agent_server:
        condition: service_healthy
    env_file:
      - .env
    environment:
      SERVER_URL: ${SERVER_URL:-http://agent_server}
      HOME: /app
      STREAMLIT_BROWSER_GATHERUSAGESTATS: "false"
      STREAMLIT_CONFIG_DIR: /app/.streamlit
    ports:
      - "8501:8501"

  postgres:
    image: ankane/pgvector
    container_name: postgres
    env_file:
      - .env
    restart: unless-stopped
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./data/candidates.csv:/data/candidates.csv:ro
      - ./db/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
      - ./db/add_rows.sql:/docker-entrypoint-initdb.d/02-add_rows.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5

  pgadmin:
    image: dpage/pgadmin4
    container_name: pgadmin
    env_file:
      - .env
    restart: unless-stopped
    ports:
      - "${PGADMIN_PORT:-8080}:80"
    depends_on:
      - postgres
    volumes:
      - pgadmin_data:/var/lib/pgadmin

volumes:
  pgdata:
  pgadmin_data:
